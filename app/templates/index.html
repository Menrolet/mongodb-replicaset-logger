<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Консоль распределенных событий</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400&family=Space+Grotesk:wght@400;500;600&display=swap");

      :root {
        --bg: #f7f2e9;
        --bg-deep: #efe4d6;
        --panel: rgba(255, 255, 255, 0.84);
        --ink: #1b1a18;
        --muted: #5f5a52;
        --accent: #ff8a3d;
        --accent-2: #2b8d98;
        --accent-3: #f2c94c;
        --danger: #d64545;
        --ok: #2f9d63;
        --shadow: 0 20px 40px rgba(27, 26, 24, 0.12);
        --radius: 22px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 12% 8%, #ffe7d5 0%, transparent 45%),
          radial-gradient(circle at 85% 18%, #d8f2f0 0%, transparent 42%),
          radial-gradient(circle at 30% 90%, #f9f3d5 0%, transparent 50%),
          linear-gradient(120deg, var(--bg) 0%, var(--bg-deep) 100%);
      }

      .shell {
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px clamp(20px, 4vw, 48px) 48px;
      }

      .hero {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 28px;
        animation: float-in 0.7s ease both;
      }

      .eyebrow {
        margin: 0 0 8px;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        font-size: 12px;
        color: var(--muted);
      }

      h1 {
        margin: 0 0 10px;
        font-size: clamp(28px, 4vw, 42px);
      }

      .sub {
        margin: 0;
        max-width: 520px;
        color: var(--muted);
      }

      .status-pill {
        padding: 10px 16px;
        border-radius: 999px;
        background: rgba(47, 141, 152, 0.14);
        color: var(--accent-2);
        font-weight: 600;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: currentColor;
        box-shadow: 0 0 0 6px rgba(47, 141, 152, 0.16);
      }

      .hero-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .lang-toggle {
        border-radius: 999px;
        padding: 10px 14px;
        background: rgba(27, 26, 24, 0.08);
        color: var(--ink);
        font-weight: 600;
        font-size: 13px;
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(280px, 360px) minmax(0, 1fr);
        gap: 24px;
        align-items: start;
      }

      .left-stack {
        display: grid;
        gap: 24px;
      }

      .panel {
        background: var(--panel);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 22px 24px;
        backdrop-filter: blur(10px);
        animation: float-in 0.6s ease both;
      }

      .panel h2 {
        margin: 0 0 16px;
        font-size: 20px;
      }

      form {
        display: grid;
        gap: 14px;
      }

      label {
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid rgba(27, 26, 24, 0.12);
        font-family: inherit;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.9);
      }

      textarea {
        min-height: 90px;
        resize: vertical;
        font-family: "DM Mono", "Courier New", monospace;
        font-size: 12px;
      }

      .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 8px;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 12px 18px;
        font-family: inherit;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .primary {
        background: var(--accent);
        color: #1b1a18;
        box-shadow: 0 10px 18px rgba(255, 138, 61, 0.35);
      }

      .ghost {
        background: rgba(27, 26, 24, 0.08);
        color: var(--ink);
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 20px rgba(27, 26, 24, 0.12);
      }

      .hint {
        margin: 10px 0 0;
        font-size: 12px;
        color: var(--muted);
      }

      .status {
        margin-top: 10px;
        font-size: 13px;
        padding: 8px 12px;
        border-radius: 12px;
        background: rgba(47, 157, 99, 0.12);
        color: var(--ok);
        display: none;
      }

      .status.error {
        background: rgba(214, 69, 69, 0.12);
        color: var(--danger);
      }

      .stats-grid {
        display: grid;
        gap: 12px;
      }

      .stat {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(27, 26, 24, 0.08);
      }

      .stat span {
        font-weight: 600;
      }

      .list-panel {
        min-height: 480px;
      }

      .list-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
      }

      .filters {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        min-width: 280px;
      }

      .list {
        display: grid;
        gap: 14px;
      }

      .event-card {
        padding: 16px 18px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(27, 26, 24, 0.06);
        display: grid;
        gap: 8px;
      }

      .event-head {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--muted);
      }

      .badge {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .badge-info { background: rgba(47, 141, 152, 0.16); color: var(--accent-2); }
      .badge-warn { background: rgba(242, 201, 76, 0.22); color: #8f6a00; }
      .badge-error { background: rgba(214, 69, 69, 0.18); color: var(--danger); }
      .badge-debug { background: rgba(80, 80, 80, 0.14); color: #333; }
      .badge-default { background: rgba(27, 26, 24, 0.1); color: var(--ink); }

      .message {
        margin: 0;
        font-size: 15px;
      }

      pre {
        margin: 0;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(27, 26, 24, 0.08);
        font-size: 12px;
        font-family: "DM Mono", "Courier New", monospace;
        overflow-x: auto;
      }

      .empty {
        padding: 20px;
        text-align: center;
        color: var(--muted);
        border: 1px dashed rgba(27, 26, 24, 0.2);
        border-radius: 16px;
      }

      .foot {
        margin-top: 32px;
        color: var(--muted);
        font-size: 12px;
        text-align: center;
      }

      @keyframes float-in {
        from { opacity: 0; transform: translateY(18px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }

        .filters {
          grid-template-columns: 1fr;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="hero">
        <div>
          <p class="eyebrow" data-i18n="eyebrow">Логгер репликасета</p>
          <h1 data-i18n="title">Консоль распределенных событий</h1>
          <p class="sub" data-i18n="sub">Быстрый интерфейс для записи событий, фильтрации и проверки статистики по уровням.</p>
        </div>
        <div class="hero-actions">
          <div class="status-pill" id="health-pill">
            <span class="status-dot" id="health-dot"></span>
            <span id="health-text" data-i18n="healthChecking">Проверяем API...</span>
          </div>
          <button class="lang-toggle" type="button" id="lang-toggle" aria-label="Switch language">EN</button>
        </div>
      </header>

      <main class="grid">
        <div class="left-stack">
          <section class="panel">
            <h2 data-i18n="newEvent">Новое событие</h2>
            <form id="event-form">
              <div>
                <label for="service" data-i18n="service">Сервис</label>
                <input id="service" name="service" placeholder="auth" data-i18n-placeholder="servicePlaceholder" required />
              </div>
              <div>
                <label for="level" data-i18n="level">Уровень</label>
                <select id="level" name="level" required>
                  <option value="info">info</option>
                  <option value="warn">warn</option>
                  <option value="error">error</option>
                  <option value="debug">debug</option>
                </select>
              </div>
              <div>
                <label for="message" data-i18n="message">Сообщение</label>
                <input id="message" name="message" placeholder="вход пользователя" data-i18n-placeholder="messagePlaceholder" required />
              </div>
              <div>
                <label for="host" data-i18n="host">Хост</label>
                <input id="host" name="host" placeholder="node1" data-i18n-placeholder="hostPlaceholder" required />
              </div>
              <div>
                <label for="metadata" data-i18n="metadata">Метаданные (JSON)</label>
                <textarea id="metadata" name="metadata" placeholder='{"user":"bob","ip":"10.0.0.1"}' data-i18n-placeholder="metadataPlaceholder"></textarea>
              </div>
              <div class="form-actions">
                <button class="primary" type="submit" data-i18n="sendEvent">Отправить событие</button>
                <button class="ghost" type="button" id="seed" data-i18n="fillSample">Заполнить пример</button>
              </div>
            </form>
            <div class="status" id="form-status"></div>
            <p class="hint" data-i18n="hint">Событие отправляется на <code>/events</code>. Время проставляется автоматически.</p>
          </section>

          <section class="panel">
            <h2 data-i18n="levelStats">Статистика по уровням</h2>
            <div class="stats-grid" id="stats-grid"></div>
          </section>
        </div>

        <section class="panel list-panel">
          <div class="list-header">
            <h2 data-i18n="events">События</h2>
            <div class="filters">
              <input id="filter-service" placeholder="Фильтр: сервис" data-i18n-placeholder="filterService" />
              <select id="filter-level">
                <option value="" data-i18n="allLevels">Все уровни</option>
                <option value="info">info</option>
                <option value="warn">warn</option>
                <option value="error">error</option>
                <option value="debug">debug</option>
              </select>
            </div>
            <button class="ghost" type="button" id="refresh" data-i18n="refresh">Обновить</button>
          </div>
          <div class="list" id="events-list"></div>
        </section>
      </main>

      <div class="foot" data-i18n="foot">FastAPI + MongoDB Replica Set. UI обновляется без перезагрузки страницы.</div>
    </div>

    <script>
      const form = document.getElementById("event-form");
      const statusBox = document.getElementById("form-status");
      const statsGrid = document.getElementById("stats-grid");
      const list = document.getElementById("events-list");
      const filterService = document.getElementById("filter-service");
      const filterLevel = document.getElementById("filter-level");
      const refreshBtn = document.getElementById("refresh");
      const seedBtn = document.getElementById("seed");
      const healthText = document.getElementById("health-text");
      const healthDot = document.getElementById("health-dot");
      const langToggle = document.getElementById("lang-toggle");

      const translations = {
        ru: {
          langToggle: "EN",
          title: "Консоль распределенных событий",
          eyebrow: "Логгер репликасета",
          sub: "Быстрый интерфейс для записи событий, фильтрации и проверки статистики по уровням.",
          healthChecking: "Проверяем API...",
          healthOnline: "API доступен",
          healthResponding: "API отвечает",
          healthOffline: "API недоступен",
          newEvent: "Новое событие",
          service: "Сервис",
          level: "Уровень",
          message: "Сообщение",
          host: "Хост",
          metadata: "Метаданные (JSON)",
          sendEvent: "Отправить событие",
          fillSample: "Заполнить пример",
          hint: "Событие отправляется на /events. Время проставляется автоматически.",
          levelStats: "Статистика по уровням",
          events: "События",
          filterService: "Фильтр: сервис",
          allLevels: "Все уровни",
          refresh: "Обновить",
          foot: "FastAPI + MongoDB Replica Set. UI обновляется без перезагрузки страницы.",
          noEventsYet: "Пока нет событий. Добавьте первое!",
          noEventsFound: "События не найдены.",
          metadataError: "Metadata должна быть корректным JSON.",
          eventSaved: "Событие сохранено.",
          eventFailed: "Не удалось отправить событие.",
          unknown: "неизвестно",
          defaultService: "сервис",
          defaultHost: "хост",
          servicePlaceholder: "auth",
          messagePlaceholder: "вход пользователя",
          hostPlaceholder: "node1",
          metadataPlaceholder: '{"user":"bob","ip":"10.0.0.1"}',
        },
        en: {
          langToggle: "RU",
          title: "Distributed Event Console",
          eyebrow: "Replica Set Logger",
          sub: "Quick console to write events, filter records, and review level statistics.",
          healthChecking: "Checking API...",
          healthOnline: "API online",
          healthResponding: "API responding",
          healthOffline: "API offline",
          newEvent: "New Event",
          service: "Service",
          level: "Level",
          message: "Message",
          host: "Host",
          metadata: "Metadata (JSON)",
          sendEvent: "Send Event",
          fillSample: "Fill Sample",
          hint: "Events are sent to /events. Timestamp is added automatically.",
          levelStats: "Level Stats",
          events: "Events",
          filterService: "Filter: service",
          allLevels: "All levels",
          refresh: "Refresh",
          foot: "FastAPI + MongoDB Replica Set. UI updates without page reloads.",
          noEventsYet: "No events yet. Add the first one!",
          noEventsFound: "No events found.",
          metadataError: "Metadata must be valid JSON.",
          eventSaved: "Event saved.",
          eventFailed: "Failed to send event.",
          unknown: "unknown",
          defaultService: "service",
          defaultHost: "host",
          servicePlaceholder: "auth",
          messagePlaceholder: "user login",
          hostPlaceholder: "node1",
          metadataPlaceholder: '{"user":"bob","ip":"10.0.0.1"}',
        },
      };

      let currentLang = localStorage.getItem("lang") || "ru";

      function t(key) {
        return translations[currentLang][key] || key;
      }

      function applyTranslations() {
        document.documentElement.lang = currentLang;
        document.title = t("title");
        document.querySelectorAll("[data-i18n]").forEach((node) => {
          const key = node.getAttribute("data-i18n");
          node.textContent = t(key);
        });
        document.querySelectorAll("[data-i18n-placeholder]").forEach((node) => {
          const key = node.getAttribute("data-i18n-placeholder");
          node.setAttribute("placeholder", t(key));
        });
        langToggle.textContent = t("langToggle");
      }

      const levelColors = {
        info: "badge-info",
        warn: "badge-warn",
        error: "badge-error",
        debug: "badge-debug",
      };

      function setStatus(message, isError = false) {
        statusBox.textContent = message;
        statusBox.classList.toggle("error", isError);
        statusBox.style.display = "block";
      }

      async function api(path, options = {}) {
        const response = await fetch(path, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || "Request failed");
        }
        if (response.status === 204) return null;
        return response.json();
      }

      async function loadHealth() {
        try {
          const data = await api("/health");
          healthText.textContent = data.status === "up" ? t("healthOnline") : t("healthResponding");
          healthDot.style.color = "var(--ok)";
        } catch (error) {
          healthText.textContent = t("healthOffline");
          healthDot.style.color = "var(--danger)";
        }
      }

      function renderStats(stats) {
        statsGrid.innerHTML = "";
        if (!stats.length) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = t("noEventsYet");
          statsGrid.appendChild(empty);
          return;
        }
        stats
          .sort((a, b) => b.count - a.count)
          .forEach((item) => {
          const row = document.createElement("div");
          row.className = "stat";
          const name = document.createElement("span");
          name.textContent = item._id || t("unknown");
            const count = document.createElement("strong");
            count.textContent = item.count;
            row.append(name, count);
            statsGrid.appendChild(row);
          });
      }

      function renderEvents(events) {
        list.innerHTML = "";
        if (!events.length) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = t("noEventsFound");
          list.appendChild(empty);
          return;
        }
        events.forEach((event) => {
          const card = document.createElement("article");
          card.className = "event-card";

          const head = document.createElement("div");
          head.className = "event-head";

          const level = (event.level || "default").toLowerCase();
          const badge = document.createElement("span");
          badge.className = `badge ${levelColors[level] || "badge-default"}`;
          badge.textContent = level;

          const meta = document.createElement("span");
          meta.textContent = `${event.service || t("defaultService")} - ${event.host || t("defaultHost")}`;

          const time = document.createElement("span");
          const date = event.timestamp ? new Date(event.timestamp) : null;
          time.textContent = date && !Number.isNaN(date.getTime())
            ? date.toLocaleString()
            : "-";

          head.append(badge, meta, time);

          const message = document.createElement("p");
          message.className = "message";
          message.textContent = event.message || "";

          card.append(head, message);

          if (event.metadata && Object.keys(event.metadata).length) {
            const metaBox = document.createElement("pre");
            metaBox.textContent = JSON.stringify(event.metadata, null, 2);
            card.append(metaBox);
          }

          list.appendChild(card);
        });
      }

      async function loadStats() {
        try {
          const data = await api("/events/stats");
          renderStats(data);
        } catch (error) {
          renderStats([]);
        }
      }

      async function loadEvents() {
        const params = new URLSearchParams();
        if (filterService.value.trim()) params.set("service", filterService.value.trim());
        if (filterLevel.value) params.set("level", filterLevel.value);
        const query = params.toString() ? `?${params.toString()}` : "";
        try {
          const data = await api(`/events${query}`);
          renderEvents(data);
        } catch (error) {
          renderEvents([]);
        }
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = {
          service: form.service.value.trim(),
          level: form.level.value,
          message: form.message.value.trim(),
          host: form.host.value.trim(),
          metadata: {},
          timestamp: new Date().toISOString(),
        };
        if (form.metadata.value.trim()) {
          try {
            payload.metadata = JSON.parse(form.metadata.value);
          } catch (error) {
            setStatus(t("metadataError"), true);
            return;
          }
        }
        try {
          await api("/events", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(t("eventSaved"));
          form.reset();
          await Promise.all([loadStats(), loadEvents()]);
        } catch (error) {
          setStatus(t("eventFailed"), true);
        }
      });

      seedBtn.addEventListener("click", () => {
        form.service.value = t("servicePlaceholder");
        form.level.value = "info";
        form.message.value = t("messagePlaceholder");
        form.host.value = t("hostPlaceholder");
        form.metadata.value = t("metadataPlaceholder");
      });

      langToggle.addEventListener("click", () => {
        currentLang = currentLang === "ru" ? "en" : "ru";
        localStorage.setItem("lang", currentLang);
        applyTranslations();
        loadHealth();
        loadStats();
        loadEvents();
      });

      filterService.addEventListener("input", () => loadEvents());
      filterLevel.addEventListener("change", () => loadEvents());
      refreshBtn.addEventListener("click", () => {
        loadStats();
        loadEvents();
      });

      applyTranslations();
      loadHealth();
      loadStats();
      loadEvents();
    </script>
  </body>
</html>
